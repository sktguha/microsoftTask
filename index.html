<head>
    <title>Task Creator</title>
    <link rel="stylesheet" href="./styles.css">
</head>

<body>
    <div id="task-modal" style="z-index: 300; position: absolute;left: 0;top: 0;background-color:white;width:100%;height:100%;
            display: none;
            justify-content: center;
            align-items: center;
        ">
        <div style="margin: 30%; width: 40%; border: 4px solid lightgray;">
            <form id="task-input">
                Title:
                <br />
                <input required type="text" id="titleInput" placeholder="Enter title text" />
                <br />
                Priority:
                <br />
                <select required id="priorityInput">
                    <option value="Important">Important</option>
                    <option value="Medium">Medium</option>
                </select>
                <br />
                Due Date:
                <br />
                <input required type="date" id="dateInput" />
                <br />
                <input type="submit" />
                <input type="button" value="cancel" id="hide-modal" />
            </form>
        </div>
    </div>
    <div style="position: absolute; z-index: 300; display:none;" id="options-menu">
        <span id="progress-not-started">Progress: Not started</span>
        <span id="progress-completed">Progress: Completed</span>
        <span id="delete-task">Delete</span>
    </div>
    <div style="width: 100%; display: flex; justify-content: center;">
        <div style="width: 40%;">
            <table id="main-table"></table>
            <div style="display:flex; flex-direction: row-reverse; width: 100%">
                <button id="add-task">Add Task</button>
            </div>
        </div>
    </div>
    <script>
        const mainTable = document.querySelector('#main-table');
        let tasks = [{ title: "This is a test", priority: "Important", dueDate: "2021-02-02", id: 8762348 }];
        const taskModal = document.querySelector('#task-modal');
        const progressNotStarted = document.querySelector('#progress-not-started');
        const progressCompleted = document.querySelector('#progress-completed');
        const deleteTask = document.querySelector('#delete-task');
        const optionsMenu = document.querySelector('#options-menu');
        function getTd(str) {
            const td = document.createElement('td');
            td.innerText = str;
            return td;
        }
        function onTaskOptionsClick(e) {
            const taskId = e.target.dataset.taskid;
            optionsMenu.style.display = 'block';
            progressNotStarted.onclick = () => {
                const task = tasks.find(t => t.id === taskId);
                task.progress = "Not Started";
                renderTable(tasks);
            }
            progressCompleted.onclick = () => {
                const task = tasks.find(t => t.id === taskId);
                task.progress = "Completed";
                renderTable(tasks);
            }
            deleteTask.onclick = () => {
                tasks = tasks.filter(task => task.id !== taskId);
                renderTable(tasks)
            }
        }
        function renderTable(tasks) {
            // TODO: improve efficiency
            const tasksToRender = tasks.sort((taskA, taskB) => {
                if (taskA.priority === "Important" && taskB.priority === "Medium") {
                    return -1;
                } else if (taskA.priority === "Medium" && taskB.priority === "Important") {
                    return 1;
                } else {
                    return new Date(Date.parse(taskA.dueDate)).getTime() - new Date(Date.parse(taskB.dueDate)).getTime()
                }
            });
            mainTable.innerHTML = "";
            const th = document.createElement('th');
            th.appendChild(getTd('Tasks'));
            th.appendChild(getTd('Priority'));
            th.appendChild(getTd('Due'));
            th.appendChild(getTd('Filter'));
            mainTable.appendChild(th);
            tasksToRender.forEach((task) => {
                const tr = document.createElement('tr');
                tr.appendChild(getTd(task.title));
                tr.appendChild(getTd(task.priority));
                tr.appendChild(getTd(task.dueDate));
                const optionsTd = getTd('...');
                optionsTd.setAttribute('data-taskid', task.id);
                optionsTd.onclick = onTaskOptionsClick;
                tr.appendChild(optionsTd);
                mainTable.appendChild(tr);
            });
        }
        function getShowAndGetNewTaskDetails(id) {
            let task;
            // TODO: add edit functionality later
            // if (id) {
            //     task = tasks.find(task => task.id === id);
            // }

        }
        function main() {
            renderTable(tasks);
            document.getElementById('add-task').onclick = function () {
                taskModal.style.display = 'flex';
            }
            document.getElementById('task-input').onsubmit = function (e) {
                e.preventDefault();
                const title = document.getElementById('titleInput').value;
                const priority = document.getElementById('priorityInput').value;
                const dueDate = document.getElementById('dateInput').value;
                const id = Math.random() + Date.now();
                const task = { title, priority, dueDate, id, progress: 'Not Started' };
                tasks.push(task);
                renderTable(tasks);
                taskModal.style.display = 'none';
            }
            document.getElementById('hide-modal').onclick = function () {
                if (window.confirm('Are you sure you want to discard this task?')) {
                    taskModal.style.display = 'none';
                }
            }
        }
        main();
    </script>
</body>